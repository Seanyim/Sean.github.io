{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
<script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
<style>
    /* Admin Specific Overrides */
    
    /* EasyMDE / CodeMirror Customization for Clean Write Mode */
    .EasyMDEContainer .CodeMirror {
        background-color: #ffffff !important;
        color: #1f2937 !important; /* Dark text */
        border: 1px solid #cbd5e1 !important;
        border-radius: 8px !important;
        font-family: 'Space Mono', monospace; 
        line-height: 1.6;
    }
    
    .EasyMDEContainer .CodeMirror-cursor {
        border-left: 1px solid var(--color-accent) !important;
    }
    
    .EasyMDEContainer .editor-toolbar {
        background-color: #f8fafc !important; /* Very light gray for toolbar */
        border: 1px solid #cbd5e1 !important;
        border-bottom: none !important;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        color: #475569 !important;
    }
    
    .EasyMDEContainer .editor-toolbar i {
        color: #475569 !important;
        transition: color 0.2s;
    }
    
    .EasyMDEContainer .editor-toolbar button:hover i,
    .EasyMDEContainer .editor-toolbar button.active i {
        color: var(--color-accent) !important;
    }
    
    .EasyMDEContainer .editor-toolbar button:hover {
        background: rgba(0,0,0,0.05) !important;
        border-color: transparent !important;
    }

    .EasyMDEContainer .editor-statusbar {
        padding: 8px 10px;
        color: #64748b !important;
    }
    
    /* Clean Input Styles (Used for Profile, Tweets, Modals) */
    .form-input, .modal-form-input { 
        width: 100%; 
        padding: 12px 16px; 
        background: #ffffff !important; 
        border: 1px solid #cbd5e1; 
        border-radius: 8px; 
        color: #1e293b; /* Dark text */
        font-family: var(--font-body);
        font-size: 15px;
        transition: all 0.2s;
    }
    .form-input:focus, .modal-form-input:focus { 
        outline: none; 
        border-color: var(--color-accent); 
        box-shadow: 0 0 0 3px var(--color-accent-glow); 
    }

    /* Tabs - Clean No Background */
    .tabs {
        display: flex; gap: 0.5rem; margin-bottom: 2rem; 
        padding: 0; background: transparent; /* Removed gray background */
        border-radius: 0; border: none;
        justify-content: center; width: 100%; margin-left: auto; margin-right: auto;
    }
    .tab-btn {
        background: transparent; color: var(--color-text-secondary);
        border: none; padding: 10px 24px; border-radius: 99px;
        font-weight: 600; cursor: pointer; transition: all 0.2s;
        font-family: var(--font-body);
        font-size: 15px;
    }
    .tab-btn:hover { color: var(--color-text-primary); background: rgba(255,255,255,0.05); }
    .tab-btn.active {
        background: var(--color-accent);
        color: #fff;
        box-shadow: 0 4px 12px var(--color-accent-glow);
    }

    /* Modal Form Styles */
    .modal-form-group { margin-bottom: 1.25rem; }
    .modal-form-label { display: block; margin-bottom: 0.5rem; font-size: 13px; font-weight: 600; color: var(--color-text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
    
    /* Button Refinements */
    .btn-pill {
        padding: 0.5rem 1.2rem;
        font-size: 13px;
        border-radius: 9999px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border: 1px solid transparent;
        background: rgba(255,255,255,0.1); 
        color: var(--color-text-secondary);
        text-decoration: none;
    }
    
    .btn-pill:hover {
        background: rgba(255,255,255,0.2);
        color: #fff;
        transform: translateY(-2px);
    }

    .btn-pill.primary {
        background: var(--color-accent);
        color: #ffffff;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }
    .btn-pill.primary:hover {
        background: var(--color-accent-hover);
        box-shadow: 0 6px 16px rgba(34, 197, 94, 0.4);
    }

    /* Modal - Solid White Window & Centered */
    /* Modal - Solid White Window & Centered */
    dialog {
        background: #ffffff !important; /* Pure White Solid */
        border: 1px solid #cbd5e1;
        border-radius: 16px;
        padding: 5rem 8rem; /* Large Padding */
        max-width: 1400px;  /* Max width constraint */
        width: 85%;         /* Natural side margins */
        color: #1e293b; 
        
        /* Centering Magic */
        position: fixed;
        inset: 0;
        margin: auto;
        
        box-shadow: 0 40px 80px -20px rgba(0, 0, 0, 0.2);
        opacity: 1;
        visibility: visible;
        overflow-y: auto; 
    }
    
    dialog::backdrop {
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
    }

    /* Modal Form Styles */
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 3rem;
    }
    
    .modal-title {
        font-family: 'Archivo', sans-serif;
        font-weight: 700;
        font-size: 2rem;
        color: #0f172a;
        margin: 0;
    }

    /* Close Button - positioned relatively in the flex header, or absolute within the padded area */
    .modal-close-btn {
        background: #f1f5f9;
        border: none;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        font-size: 24px;
        color: #64748b;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        /* Ensure it's not sticking to viewport edge if it was fixed before */
    }
    .modal-close-btn:hover {
        background: #e2e8f0;
        color: #ef4444;
        transform: rotate(90deg);
    }

    /* Reset inner wrapper */
    .modal-content-box {
        background: transparent;
        border: none;
        box-shadow: none;
        padding: 0;
        color: inherit;
    }
    
    .modal-form-label {
        display: block; 
        margin-bottom: 0.8rem; 
        font-size: 14px; 
        font-weight: 600; 
        color: #475569; 
        text-transform: uppercase; 
        letter-spacing: 0.05em; 
    }

    .btn-pill.danger {
        background: #ef4444;
        color: #ffffff;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    .btn-pill.danger:hover {
        background: #dc2626;
        box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
    }

    /* Emoji Helper */
    .emoji-picker-btn {
        position: absolute; bottom: 12px; right: 12px;
        background: transparent; border: none; border-radius: 50%;
        width: 28px; height: 28px; font-size: 18px; opacity: 0.6;
        cursor: pointer; transition: all 0.2s; display: flex; justify-content: center; align-items: center;
    }
    .emoji-picker-btn:hover { background: rgba(0,0,0,0.05); opacity: 1; transform: scale(1.1); }
    .form-group { position: relative; margin-bottom: 1.5rem; }
    label { display: block; margin-bottom: 0.5rem; font-size: 14px; font-weight: 600; color: var(--color-text-secondary); }
</style>

<section class="hero section-header" style="padding-bottom: 2rem;">
    <div class="container">
        <h1>Content Manager</h1>
        <p class="lead">Create, Edit, Publish.</p>
    </div>
</section>

<!-- Main Container: Removing max-width restriction to fill page standard container -->
<div class="container" style="padding-bottom: 4rem;">
    
    <!-- Tabs -->
    <div class="tabs" style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid var(--color-border); padding-bottom: 1rem; justify-content: center;">
        <button class="tab-btn active" onclick="showTab('profile')">Profile</button>
        <button class="tab-btn" onclick="showTab('blogs')">Blogs</button>
        <button class="tab-btn" onclick="showTab('projects')">Projects</button>
        <button class="tab-btn" onclick="showTab('tweets')">Tweets</button>
    </div>

    <!-- PROFILE (Simple Form, no modal needed) -->
    <div id="tab-profile" class="tab-content">
        <form id="profile-form" class="card">
            <h3>Edit Profile</h3>
            <div class="grid-2">
                <div class="form-group">
                    <label>Avatar</label>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <img src="{{ profile.avatar_url }}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                        <input type="file" onchange="uploadAvatar(this)" class="form-input">
                    </div>
                    <input type="hidden" name="avatar_url" id="profile-avatar-url" value="{{ profile.avatar_url }}">
                </div>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" name="name" value="{{ profile.name }}" class="form-input">
                </div>
            </div>
            <div class="form-group">
                <label>Tagline</label>
                <input type="text" name="tagline" value="{{ profile.tagline }}" class="form-input">
            </div>
            <div class="form-group" style="position: relative;">
                <label>About</label>
                <textarea name="about" id="profile-about" class="form-input" rows="4">{{ profile.about }}</textarea>
                <button type="button" class="emoji-picker-btn" onclick="insertEmojiAttr(this)" data-target="profile-about">üòä</button>
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label>GitHub</label>
                    <input type="text" name="github_link" value="{{ profile.github_link }}" class="form-input">
                </div>
                <div class="form-group">
                    <label>LinkedIn</label>
                    <input type="text" name="linkedin_link" value="{{ profile.linkedin_link }}" class="form-input">
                </div>
            </div>
            <button type="button" onclick="saveProfile()" class="btn-pill primary" style="padding: 0.8rem 2rem; width: 100%; justify-content: center; font-size: 16px;">Save Profile</button>
        </form>
    </div>

    <!-- BLOGS -->
    <div id="tab-blogs" class="tab-content" style="display:none;">
        <button onclick="openBlogModal()" class="btn-pill primary" style="margin-bottom: 2rem; width: 100%; justify-content: center;">+ New Blog Post</button>
        <div id="blogs-list">
            {% for blog in blogs %}
            <div class="card blog-item" style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; padding: 1.2rem;">
                <div>
                    <strong style="font-size: 1.1em; display: block; margin-bottom: 4px;">{{ blog.title }}</strong>
                    <div style="font-size: 13px; color: var(--color-text-secondary); display: flex; gap: 10px;">
                        <span>üìÖ {{ blog.date }}</span>
                        <span>üè∑Ô∏è {{ blog.category }}</span>
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick='openBlogModal({{ blog|tojson }})' class="btn-pill">Edit</button>
                    <button onclick="deleteItem('blogs', {{ blog.id }})" class="btn-pill danger">Delete</button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- PROJECTS -->
    <div id="tab-projects" class="tab-content" style="display:none;">
        <button onclick="openProjectModal()" class="btn-pill primary" style="margin-bottom: 2rem; width: 100%; justify-content: center;">+ New Project</button>
        <div id="projects-list">
            {% for proj in projects %}
            <div class="card" style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; padding: 1.2rem;">
                <div>
                    <strong style="font-size: 1.1em; display: block; margin-bottom: 4px;">{{ proj.title }}</strong>
                    <div style="font-size: 13px; color: var(--color-text-secondary);">üè∑Ô∏è {{ proj.category }}</div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick='openProjectModal({{ proj|tojson }})' class="btn-pill">Edit</button>
                    <button onclick="deleteItem('projects', {{ proj.id }})" class="btn-pill danger">Delete</button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- TWEETS -->
    <div id="tab-tweets" class="tab-content" style="display:none;">
        <div class="card" style="margin-bottom: 2rem;">
            <h3>Post Tweet</h3>
            <div class="form-group">
                <textarea id="new-tweet-content" placeholder="What's happening?" class="form-input" rows="3" style="resize: vertical;"></textarea>
                <button type="button" class="emoji-picker-btn" onclick="insertEmojiAttr(this)" data-target="new-tweet-content">üòä</button>
            </div>
            <div class="flex-between" style="margin-top: 1rem;">
                <input type="text" id="new-tweet-category" placeholder="Category" class="form-input" style="width: 200px;">
                <button onclick="quickPostTweet()" class="btn-pill primary">Post Tweet</button>
            </div>
        </div>
        <div id="tweets-list">
            {% for tweet in tweets %}
            <div class="card tweet-item" style="margin-bottom: 1rem;">
                <div class="flex-between" style="align-items: flex-start;">
                    <div>
                        <div style="font-weight: 500; font-size: 1.05rem; margin-bottom: 6px;">{{ tweet.content }}</div>
                        <div style="font-size: 12px; color: var(--color-text-secondary);">{{ tweet.date }} | {{ tweet.category }}</div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button onclick='openTweetModal({{ tweet|tojson }})' class="btn-pill">Edit</button>
                        <button onclick="deleteItem('tweets', {{ tweet.id }})" class="btn-pill danger">Delete</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

</div>

<!-- DATA STORE for easy JS access -->
<script>
    let blogsData = {{ blogs|tojson }};
    let projectsData = {{ projects|tojson }};
    let tweetsData = {{ tweets|tojson }};
</script>

<!-- BLOG MODAL -->
<dialog id="blog-modal">
    <div class="modal-content-box">
        <div class="modal-header">
            <h2 class="modal-title">Blog Editor</h2>
            <button type="button" class="modal-close-btn" onclick="document.getElementById('blog-modal').close()">&times;</button>
        </div>
        
        <form id="blog-form" onsubmit="event.preventDefault(); saveBlog();">
            <input type="hidden" id="blog-id">
            
            <div class="modal-form-group">
                <label class="modal-form-label" for="blog-title">Title</label>
                <input type="text" id="blog-title" class="modal-form-input" required placeholder="Enter blog title...">
            </div>
            
            <div class="grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 1.5rem;">
                <div class="modal-form-group" style="margin-bottom: 0;">
                    <label class="modal-form-label" for="blog-category">Category</label>
                    <input type="text" id="blog-category" class="modal-form-input">
                </div>
                <div class="modal-form-group" style="margin-bottom: 0;">
                    <label class="modal-form-label" for="blog-date">Date</label>
                    <input type="date" id="blog-date" class="modal-form-input">
                </div>
            </div>

            <div class="modal-form-group">
                <label class="modal-form-label">Content (Markdown supported, paste images)</label>
                <textarea id="blog-content"></textarea>
            </div>
            
            <button class="btn-pill primary" style="width: 100%; justify-content: center; padding: 1rem;">Save Blog</button>
        </form>
    </div>
</dialog>

<!-- PROJECT MODAL -->
<dialog id="project-modal">
    <div class="modal-content-box">
        <div class="modal-header">
            <h2 class="modal-title">Project Editor</h2>
            <button type="button" class="modal-close-btn" onclick="document.getElementById('project-modal').close()">&times;</button>
        </div>
        
        <div class="text-center" style="margin-bottom: 2rem;">
            <div class="nav-avatar-small" style="width: 80px; height: 80px; margin: 0 auto 1rem; border-radius: 12px; font-size: 32px;" id="proj-icon-preview">üíª</div>
            <button class="btn-pill" onclick="document.getElementById('proj-icon-input').click()">Change Icon (Emoji/Image)</button>
            <input type="file" id="proj-icon-input" hidden accept="image/*" onchange="uploadIcon(this)">
        </div>

        <form onsubmit="event.preventDefault(); saveProject();">
            <input type="hidden" id="proj-id">
            
            <div class="modal-form-group">
                <label class="modal-form-label">Title</label>
                <input type="text" id="proj-title" class="modal-form-input" required>
            </div>
            
            <div class="grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 1.5rem;">
                <div class="modal-form-group" style="margin-bottom: 0;">
                    <label class="modal-form-label">Category</label>
                    <input type="text" id="proj-category" class="modal-form-input">
                </div>
                <div class="modal-form-group" style="margin-bottom: 0;">
                    <label class="modal-form-label">Link</label>
                    <input type="text" id="proj-link" class="modal-form-input" placeholder="https://...">
                </div>
            </div>

            <div class="modal-form-group">
                <label class="modal-form-label">Short Description</label>
                <input type="text" id="proj-desc" class="modal-form-input">
            </div>

            <div class="modal-form-group">
                <label class="modal-form-label">Details (Markdown supported, paste images)</label>
                <textarea id="proj-details"></textarea>
            </div>
            
            <button class="btn-pill primary" style="width: 100%; justify-content: center; padding: 1rem;">Save Project</button>
        </form>
    </div>
</dialog>

<!-- TWEET MODAL -->
<dialog id="tweet-modal">
    <div class="modal-content-box">
        <div class="modal-header">
            <h2 class="modal-title">Tweet Editor</h2>
            <button type="button" class="modal-close-btn" onclick="document.getElementById('tweet-modal').close()">&times;</button>
        </div>
        <form onsubmit="event.preventDefault(); saveTweet();">
            <input type="hidden" id="tweet-id">
            
            <div class="modal-form-group">
                <label class="modal-form-label">Moment (Date/Time)</label>
                <input type="text" id="tweet-date" class="modal-form-input" placeholder="e.g. Just now, or YYYY-MM-DD">
            </div>
            
            <div class="modal-form-group">
                <label class="modal-form-label">Content (Markdown supported)</label>
                <textarea id="tweet-content" class="modal-form-input" rows="6" style="font-family: 'Space Mono', monospace;"></textarea>
            </div>
            
            <button class="btn-pill primary" style="width: 100%; justify-content: center; padding: 1rem;">Post Tweet</button>
        </form>
    </div>
</dialog>
<script>
    // --- EasyMDE Initialization ---
    let blogEditor, projEditor;

    document.addEventListener('DOMContentLoaded', () => {
        const commonOptions = {
            spellChecker: false,
            uploadImage: true,
            imageUploadFunction: uploadImageHandler,
            toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|", "link", "image", "|", "preview", "side-by-side", "fullscreen", "|", "guide"],
            status: false,
        };
        blogEditor = new EasyMDE({ element: document.getElementById("blog-content"), ...commonOptions });
        projEditor = new EasyMDE({ element: document.getElementById("proj-details"), ...commonOptions });
    });


    async function uploadImageHandler(file, onSuccess, onError) {
        const formData = new FormData();
        try {
            const res = await fetch('/api/upload', {method: 'POST', body: formData});
            const data = await res.json();
            onSuccess(data.url);
        } catch(e) {
            onError(e.message);
        }
    }

    // --- Modal Logic ---
    function closeModal(id) {
        document.getElementById(id).close();
    }

    function openBlogModal(blog = null) {
        const modal = document.getElementById('blog-modal');
        document.getElementById('blog-id').value = blog ? blog.id : '';
        document.getElementById('blog-title').value = blog ? blog.title : '';
        document.getElementById('blog-category').value = blog ? blog.category : '';
        document.getElementById('blog-date').value = blog ? blog.date : new Date().toISOString().split('T')[0];
        
        blogEditor.value(blog ? blog.content : '');
        // Refresh easyMDE after modal opens (sometimes it needs a redraw)
        setTimeout(() => {
            blogEditor.codemirror.refresh();
        }, 200);
        
        modal.showModal();
    }

    function openProjectModal(proj = null) {
        const modal = document.getElementById('project-modal');
        document.getElementById('proj-id').value = proj ? proj.id : '';
        document.getElementById('proj-title').value = proj ? proj.title : '';
        document.getElementById('proj-category').value = proj ? proj.category : '';
        document.getElementById('proj-desc').value = proj ? proj.description : '';
        document.getElementById('proj-link').value = proj ? proj.link : '';
        
        projEditor.value(proj ? proj.details : '');
        setTimeout(() => {
            projEditor.codemirror.refresh();
        }, 200);
        
        modal.showModal();
    }

    // --- Tweet Logic ---
    // Note: Tweets currently use a simple form at the top of the list, 
    // OR the modal for editing existing ones?
    // The HTML has a #tweet-modal but the UI shows a "Post Tweet" card in the tab.
    // Let's support editing if we want, or just posting.
    // Given the HTML structure in the previous step, we have a #tweet-modal.
    
    // --- Avatar Upload ---
    async function uploadAvatar(input) {
        const file = input.files[0];
        const formData = new FormData();
        formData.append('file', file);
        try {
            const res = await fetch('/api/upload/avatar', {method: 'POST', body: formData});
            const data = await res.json();
            document.getElementById('profile-avatar-url').value = data.url;
            input.previousElementSibling.src = data.url;
        } catch(e) { console.error(e); alert("Upload failed"); }
    }
    
    // --- Icon Upload for Project ---
    async function uploadIcon(input) {
         const file = input.files[0];
         if(!file) return;
         // Reuse the generic upload handler logic or make specific endpoint if needed.
         // Let's use generic upload for project icons
         const formData = new FormData();
         formData.append('file', file);
         try {
             const res = await fetch('/api/upload', {method: 'POST', body: formData});
             const data = await res.json();
             // Just show preview, we don't have a hidden input for icon url yet in the form?
             // Wait, the project object doesn't have an icon field distinct from internal logic?
             // Let's just update the preview and maybe append to description or specialized field?
             // For now, let's just alert the URL commands copy. 
             // Or better: Insert into the active editor? 
             // Project Icons are usually for the card. The current data model 'projects.json' 
             // might need an 'icon' field. 
             // Let's skip persistent icon saves for now unless requested.
             document.getElementById('proj-icon-preview').innerHTML = `<img src="${data.url}" style="width:100%; height:100%; object-fit:cover; border-radius:12px;">`;
         } catch(e) { console.error(e); }
    }

    // --- SAVE LOGIC ---
    
    async function saveProfile() {
        const formData = new FormData(document.getElementById('profile-form'));
        await fetch('/api/save/profile', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(Object.fromEntries(formData.entries()))
        });
        alert('Profile Saved');
    }

    async function saveBlog() {
        const id = document.getElementById('blog-id').value;
        const newBlog = {
            id: id ? parseInt(id) : Date.now(), // Generate ID if new
            title: document.getElementById('blog-title').value,
            date: document.getElementById('blog-date').value,
            category: document.getElementById('blog-category').value,
            content: blogEditor.value()
        };

        // Update local list
        let idx = blogsData.findIndex(b => b.id == newBlog.id);
        if (idx >= 0) blogsData[idx] = newBlog;
        else blogsData.unshift(newBlog);

        await fetch('/api/save/blogs', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(blogsData)
        });
        
        location.reload();
    }

    async function saveProject() {
        const id = document.getElementById('proj-id').value;
        const newProj = {
            id: id ? parseInt(id) : Date.now(),
            title: document.getElementById('proj-title').value,
            category: document.getElementById('proj-category').value,
            description: document.getElementById('proj-desc').value,
            link: document.getElementById('proj-link').value,
            details: projEditor.value()
        };

        let idx = projectsData.findIndex(p => p.id == newProj.id);
        if (idx >= 0) projectsData[idx] = newProj;
        else projectsData.unshift(newProj);

        await fetch('/api/save/projects', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(projectsData)
        });
        location.reload();
    }

    async function deleteItem(type, id) {
        if(!confirm('Delete this?')) return;
        
        let data = (type === 'blogs') ? blogsData : (type === 'projects' ? projectsData : (type === 'tweets' ? tweetsData : null));
        
        if (data) {
             data = data.filter(i => i.id != id);
             // Update global var
             if(type==='blogs') blogsData=data;
             if(type==='projects') projectsData=data;
             if(type==='tweets') tweetsData=data;

             await fetch(`/api/save/${type}`, {
                 method: 'POST',
                 headers: {'Content-Type': 'application/json'},
                 body: JSON.stringify(data)
             });
             location.reload();
        }
    }

    // --- TWEET LOGIC ---

    function getPreciseTime() {
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        const hh = String(now.getHours()).padStart(2, '0');
        const min = String(now.getMinutes()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd} ${hh}:${min}`;
    }

    function openTweetModal(tweet = null) {
        const modal = document.getElementById('tweet-modal');
        document.getElementById('tweet-id').value = tweet ? tweet.id : '';
        document.getElementById('tweet-date').value = tweet ? tweet.date : getPreciseTime();
        document.getElementById('tweet-content').value = tweet ? tweet.content : '';
        
        modal.showModal();
    }

    async function saveTweet() {
        // Handle saving from the Modal form
        const id = document.getElementById('tweet-id').value;
        const newTweet = {
            id: id ? parseInt(id) : Date.now(),
            content: document.getElementById('tweet-content').value,
            date: document.getElementById('tweet-date').value || getPreciseTime(),
            category: "General" // Modal doesn't have category input in current HTML, maybe add later if needed, or default
        };

        let idx = tweetsData.findIndex(t => t.id == newTweet.id);
        if (idx >= 0) tweetsData[idx] = newTweet;
        else tweetsData.unshift(newTweet);

        await fetch('/api/save/tweets', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(tweetsData)
        });
        location.reload();
    }

    async function quickPostTweet() {
        // Logic for the 'Quick Post' card at top of tweets tab
        const content = document.getElementById('new-tweet-content').value;
        const category = document.getElementById('new-tweet-category').value || "General";
        
        if(!content) return alert("Write something!");

        const newTweet = {
            id: Date.now(),
            content: content,
            category: category,
            date: getPreciseTime()
        };

        tweetsData.unshift(newTweet);

        await fetch('/api/save/tweets', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(tweetsData)
        });
        location.reload();
    }

    // --- Helper Logic ---
    function insertEmojiAttr(btn) {
        // Simple manual picker or random for demo, since "Can Add" was requested. 
        // Let's implement a quick prompt or minimal list.
        const emojis = ['üòä', 'üöÄ', 'üíª', 'üêç', '‚ú®', 'üî•', 'üìö', 'üõ†Ô∏è', 'üé®', '‚ö°', 'üåô', 'üå±'];
        // Ideally show a popover. For simplicity and reliability without ext libs, let's toggle a mini toolbar or just insert a common one.
        // Let's make a really simple picker by appending buttons near the clicked one.
        
        let existingPicker = document.querySelector('.emoji-temp-picker');
        if (existingPicker) { existingPicker.remove(); return; }

        const picker = document.createElement('div');
        picker.className = 'emoji-temp-picker card';
        picker.style.position = 'absolute';
        picker.style.bottom = '40px';
        picker.style.right = '0';
        picker.style.padding = '10px';
        picker.style.zIndex = '100';
        picker.style.display = 'grid';
        picker.style.gridTemplateColumns = 'repeat(4, 1fr)';
        picker.style.gap = '5px';
        
        const targetId = btn.getAttribute('data-target');
        const targetEl = document.getElementById(targetId);

        emojis.forEach(e => {
            const span = document.createElement('button');
            span.textContent = e;
            span.className = 'btn-ghost';
            span.style.padding = '5px';
            span.type = 'button';
            span.onclick = () => {
                const start = targetEl.selectionStart;
                const end = targetEl.selectionEnd;
                const text = targetEl.value;
                const before = text.substring(0, start);
                const after = text.substring(end, text.length);
                targetEl.value = before + e + after;
                targetEl.selectionStart = targetEl.selectionEnd = start + e.length;
                targetEl.focus();
                picker.remove();
            };
            picker.appendChild(span);
        });
        
        btn.parentElement.appendChild(picker);
        
        // Close on clean click outside
        setTimeout(() => {
            document.addEventListener('click', function closePicker(e) {
                if (!picker.contains(e.target) && e.target !== btn) {
                    picker.remove();
                    document.removeEventListener('click', closePicker);
                }
            });
        }, 100);
    }

    // --- Styling Tabs ---
    function showTab(id) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.getElementById('tab-' + id).style.display = 'block';
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }
</script>
{% endblock %}
