{% extends "base.html" %}

{% block content %}
<section class="hero section-header">
    <div class="container">
        <h1>Selected Work</h1>
        <p class="lead">A collection of projects and experiments.</p>
    </div>
</section>

<style>
    .category-section { margin-bottom: 4rem; }
    .category-title { 
        font-size: 1.5rem; 
        color: var(--color-text-primary); 
        margin-bottom: 2rem; 
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .category-icon-header { color: #22c55e; }
    
    /* Auto-Avatar SVGs defined as macros or variables not easy in Jinja loop without defining first.
       We will do inline conditional logic for icons. 
    */
    
    /* Ensure modal is perfectly centered */
    .project-modal {
        inset: 0;
        margin: auto;
        position: fixed;
        max-width: 800px;
        width: 90%;
        max-height: 90vh; /* Allow it to fit */
    }
</style>

<div class="container">
    <!-- Filter Chips -->
    <div class="filter-container" style="margin-bottom: 2rem;">
        <button class="filter-chip active" onclick="filterSections('all', this)">All</button>
        {% set categories = [] %}
        {% for cat, _ in projects|groupby('category') %}
            <button class="filter-chip" onclick="filterSections('{{ cat }}', this)">{{ cat }}</button>
        {% endfor %}
    </div>

    {% for category, items in projects|groupby('category') %}
    <section class="category-section" data-category="{{ category }}">
        <h2 class="category-title">
            <!-- Icon Logic based on Category Name -->
            <span class="category-icon-header">
                {% if 'Web' in category or 'App' in category %}
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 3v18"/><path d="M15 3v18"/><path d="M3 9h18"/><path d="M3 15h18"/></svg>
                {% elif 'AI' in category or 'Data' in category or 'Model' in category %}
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                {% elif 'Tool' in category or 'Script' in category %}
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                {% else %}
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                {% endif %}
            </span>
            {{ category }}
        </h2>
        
        <div class="projects-grid">
            {% for project in items %}
            <article class="project-card" onclick='openProjectModal({{ project|tojson }})' style="cursor: pointer;">
                <div class="card-content">
                    <h3 class="project-title" style="margin-top: 0;">{{ project.title }}</h3>
                    <p class="project-desc">{{ project.description }}</p>
                </div>
            </article>
            {% endfor %}
        </div>
    </section>
    {% endfor %}
</div>

<!-- PROJECT DETAIL MODAL -->
<dialog id="project-modal" class="project-modal">
    <div class="project-modal-content">
        <button class="project-modal-close" onclick="closeProjectModal()">&times;</button>
        <h2 id="modal-title" style="margin-top: 0; font-size: 2rem; color: #0f172a;"></h2>
        <div style="margin-bottom: 1rem;">
            <span id="modal-category" class="tech-badge" style="background: #e2e8f0; color: #475569;"></span>
        </div>
        <div id="modal-body" style="line-height: 1.6;"></div>
        <div style="margin-top: 2rem; border-top: 1px solid #e2e8f0; padding-top: 1rem;">
            <a id="modal-link" href="#" target="_blank" class="btn-primary" style="display: inline-block; text-decoration: none; color: white; background: #22c55e; padding: 0.5rem 1.5rem; border-radius: 99px;">View Project</a>
        </div>
    </div>
</dialog>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    function openProjectModal(project) {
        const modal = document.getElementById('project-modal');
        document.getElementById('modal-title').textContent = project.title;
        document.getElementById('modal-category').textContent = project.category;
        
        // Use Details if available, else Description. Convert newlines to <br> for simple formatting
        // content could also be markdown if we used the editor. 
        // Let's try to use marked if available, otherwise fallback.
        const rawContent = project.details || project.description || "";
        
        if (typeof marked !== 'undefined') {
             document.getElementById('modal-body').innerHTML = marked.parse(rawContent);
        } else {
             document.getElementById('modal-body').innerHTML = rawContent.replace(/\n/g, '<br>');
        }

        const linkBtn = document.getElementById('modal-link');
        if (project.link) {
            linkBtn.href = project.link;
            linkBtn.style.display = 'inline-block';
        } else {
            linkBtn.style.display = 'none';
        }

        modal.showModal();
    }

    function closeProjectModal() {
        const modal = document.getElementById('project-modal');
        modal.close();
    }

    // Close on click outside
    document.getElementById('project-modal').addEventListener('click', (e) => {
        if (e.target.id === 'project-modal') {
            closeProjectModal();
        }
    });

    function filterSections(category, btn) {
        // Update active chip
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');

        // Filter sections
        const sections = document.querySelectorAll('.category-section');
        sections.forEach(sec => {
            if (category === 'all' || sec.dataset.category === category) {
                sec.style.display = 'block';
            } else {
                sec.style.display = 'none';
            }
        });
    }
</script>
    <style>
        /* ... existing styles ... */
        .project-modal {
            border: none;
            border-radius: 16px;
            padding: 0;
            max-width: 800px;
            width: 90%;
            background: transparent;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .project-modal::backdrop {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
        .project-modal-content {
            background: #ffffff; /* Explicitly White Background */
            color: #1e293b;      /* Dark text for contrast on white */
            padding: 2rem;
            border-radius: 16px;
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
        }
        .project-modal-close {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #64748b;
        }
        .project-modal-close:hover { color: #0f172a; }
    </style>
{% endblock %}
